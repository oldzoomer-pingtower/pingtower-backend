# Система ошибок и кодов ответов

## 1. Общие принципы обработки ошибок

API системы мониторинга PingTower следует стандартам HTTP для обозначения результата операций. Все ошибки возвращаются в формате JSON с соответствующим HTTP кодом состояния.

## 2. Стандартные HTTP коды состояния

### 2.1. Успешные операции

- **200 OK** - Запрос успешно выполнен. Используется для операций GET, PUT, PATCH.
- **201 Created** - Ресурс успешно создан. Используется для операций POST.
- **204 No Content** - Запрос успешно выполнен, но ответ пустой. Используется для операций DELETE.

### 2.2. Ошибки клиента

- **400 Bad Request** - Некорректный запрос. Запрос содержит синтаксическую ошибку или не может быть понят сервером.
- **401 Unauthorized** - Необходима аутентификация. Запрос требует аутентификации пользователя.
- **403 Forbidden** - Доступ запрещен. У пользователя нет прав для доступа к запрашиваемому ресурсу.
- **404 Not Found** - Ресурс не найден. Запрашиваемый ресурс не существует.
- **405 Method Not Allowed** - Метод не разрешен. Использован HTTP метод, который не поддерживается для данного ресурса.
- **409 Conflict** - Конфликт. Запрос не может быть выполнен из-за конфликта с текущим состоянием ресурса.
- **422 Unprocessable Entity** - Невозможно обработать сущность. Запрос синтаксически корректен, но семантически содержит ошибки (например, нарушение бизнес-логики).
- **429 Too Many Requests** - Слишком много запросов. Пользователь превысил лимит запросов.

### 2.3. Ошибки сервера

- **500 Internal Server Error** - Внутренняя ошибка сервера. Произошла неожиданная ошибка на сервере.
- **501 Not Implemented** - Не реализовано. Сервер не поддерживает функциональность, необходимую для выполнения запроса.
- **503 Service Unavailable** - Сервис недоступен. Сервер временно не может обработать запрос из-за перегрузки или технических работ.

## 3. Формат сообщений об ошибках

Все ошибки возвращаются в формате JSON с следующей структурой:

```json
{
  "timestamp": "ISO8601 datetime",
  "status": "number",
  "error": "string",
  "message": "string",
  "path": "string"
}
```

Где:

- **timestamp** - Время возникновения ошибки в формате ISO8601.
- **status** - HTTP код состояния.
- **error** - Краткое описание ошибки.
- **message** - Подробное описание ошибки.
- **path** - Путь к ресурсу, который вызвал ошибку.

Пример сообщения об ошибке:

```json
{
  "timestamp": "2023-10-27T10:15:30.000+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "Validation failed for argument [0] in method [public org.springframework.http.ResponseEntity ru.oldzoomer.pingtower.settingsmanager.controller.SettingsController.createSetting(ru.oldzoomer.pingtower.settingsmanager.dto.CreateSettingRequest)], with 1 error(s): [Field error in object 'createSettingRequest' on field 'key': rejected value [null]; codes [NotNull.createSettingRequest.key,NotNull.key,NotNull.java.lang.String,NotNull]; arguments [org.springframework.context.support.DefaultMessageSourceResolvable: codes [createSettingRequest.key,key]; arguments []; default message [key]]; default message [must not be null]]",
  "path": "/api/v1/settings"
}
```

## 4. Валидация входных данных

API выполняет валидацию всех входных данных. При обнаружении ошибок валидации возвращается код 400 (Bad Request) с подробным описанием ошибок.

Пример ошибки валидации:

```json
{
  "timestamp": "2023-10-27T10:15:30.000+00:00",
  "status": 400,
  "error": "Bad Request",
  "message": "Validation failed",
  "path": "/api/v1/pinger/checks",
  "errors": [
    {
      "field": "resourceUrl",
      "message": "must not be null"
    },
    {
      "field": "frequency",
      "message": "must be greater than 0"
    }
  ]
}
```

## 5. Обработка исключений

Все исключения, возникающие в процессе обработки запросов, перехватываются и преобразуются в соответствующие HTTP ответы с кодами ошибок. Это обеспечивает согласованный формат ответов об ошибках для всех клиентов API.

## 6. Логирование ошибок

Все ошибки логируются на сервере с указанием:

- Времени возникновения ошибки
- Типа ошибки
- Сообщения об ошибке
- Стека вызовов (для внутренних ошибок сервера)
- Идентификатора запроса (если доступен)
- IP-адреса клиента

Это позволяет администраторам и разработчикам анализировать и устранять проблемы в API.

## 7. Retry и идемпотентность

Некоторые операции API являются идемпотентными, что означает, что повторное выполнение операции с теми же параметрами не изменит состояние системы. Клиенты могут безопасно повторять идемпотентные операции в случае ошибок.

Идемпотентные методы:

- GET
- PUT
- DELETE

Неидемпотентные методы:

- POST

Для неидемпотентных операций API может возвращать код 409 (Conflict), если повторная попытка создания ресурса приведет к конфликту.
