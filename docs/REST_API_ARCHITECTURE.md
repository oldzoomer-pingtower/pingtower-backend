# Архитектура REST API системы мониторинга PingTower

## 1. Введение

Этот документ описывает архитектуру и спецификацию REST API для системы мониторинга PingTower. REST API обеспечивает программный доступ ко всем функциям системы и позволяет интегрировать мониторинг с существующими DevOps-инструментами, системами управления инцидентами и платформами автоматизации.

## 2. Общая архитектура

### 2.1. Технологический стек

- **Язык программирования**: Java
- **Фреймворк**: Spring Boot
- **Система сборки**: Gradle
- **Аутентификация и авторизация**: OAuth2, Spring Security
- **Документирование API**: SpringDoc OpenAPI (Swagger)
- **Формат данных**: JSON

### 2.2. Принципы проектирования

API следует принципам RESTful архитектуры:

- **Состояние клиент-сервер**: Клиент и сервер отделены, что позволяет им развиваться независимо.
- **Без сохранения состояния**: Каждый запрос от клиента к серверу должен содержать всю информацию, необходимую для понимания запроса.
- **Кэшируемость**: Ответы сервера явно определяются как кэшируемые или некэшируемые.
- **Единообразный интерфейс**: Упрощает архитектуру и видимость взаимодействия.
- **Многоуровневая система**: Иерархия ограничений между компонентами.
- **Код по требованию (опционально)**: Возможность передачи исполняемого кода от сервера к клиенту.

### 2.3. Версионирование

API будет использовать версионирование через URL:

```text
https://api.example.com/v1/
```

Это позволяет поддерживать несколько версий API одновременно и обеспечивает обратную совместимость.

### 2.4. Форматы данных

Все данные передаются в формате JSON. Заголовки запросов и ответов должны указывать на использование JSON:

```text
Content-Type: application/json
Accept: application/json
```

### 2.5. Обработка ошибок

API использует стандартные HTTP коды состояния для обозначения результата операции. Подробнее о кодах ошибок будет описано в соответствующем разделе.

## 3. Аутентификация и авторизация

### 3.1. Механизмы аутентификации

API поддерживает OAuth2 для аутентификации пользователей. Поддерживаются следующие провайдеры аутентификации:

- Keycloak (основной провайдер)
- Другие OAuth2-совместимые провайдеры

Для аутентификации клиенты должны получить токен доступа и передавать его в заголовке Authorization:

```text
Authorization: Bearer <access_token>
```

### 3.2. Авторизация

Авторизация осуществляется на основе ролей пользователей. Поддерживаются следующие роли:

- `PINGTOWER_USER` - базовый доступ к API
- `PINGTOWER_EDITOR` - возможность изменения настроек и запуска проверок
- `PINGTOWER_ADMIN` - полный доступ ко всем функциям системы

### 3.3. Rate Limiting

Для предотвращения DoS-атак и обеспечения стабильной работы системы реализованы механизмы ограничения количества запросов:

- Ограничение по IP-адресу
- Ограничение по пользователю
- Ограничение по типу запроса

## 4. Безопасность

### 4.1. Шифрование данных

- Все коммуникации между клиентами и API защищены с помощью TLS/HTTPS.
- Чувствительные данные (например, токены доступа к внешним системам) шифруются перед сохранением в базу данных.
- Используется AES-256 для шифрования данных.

### 4.2. Управление секретами

- API получает секреты через безопасный канал при запуске.

### 4.3. Аудит и логирование

- Все операции с данными логируются с указанием пользователя, времени и типа операции.
- Попытки несанкционированного доступа логируются и передаются в систему мониторинга.
- Подозрительные действия анализируются системой SIEM.

## 5. Документирование API

### 5.1. OpenAPI (Swagger)

API документируется с использованием спецификации OpenAPI (Swagger). Это позволяет:

- Автоматически генерировать документацию
- Создавать интерактивные документы для тестирования API
- Генерировать клиентские библиотеки для различных языков программирования

### 5.2. Доступ к документации

Документация доступна по следующим URL:

- Swagger UI: `https://api.example.com/v1/swagger-ui.html`
- OpenAPI JSON: `https://api.example.com/v1/v3/api-docs`

## 6. Расширяемость

### 6.1. Модульная архитектура

API спроектирован с учетом модульности, что позволяет легко добавлять новые функции и расширять существующие.

### 6.2. Совместимость

При добавлении новых функций сохраняется обратная совместимость с предыдущими версиями API.

## 7. Мониторинг и метрики

### 7.1. Health Checks

Реализованы эндпоинты для проверки состояния сервисов:

- `GET /health` - общее состояние системы
- `GET /health/liveness` - проверка живучести
- `GET /health/readiness` - проверка готовности к работе

### 7.2. Метрики

Сбор метрик производительности осуществляется через систему мониторинга.

## 8. Заключение

Архитектура REST API системы мониторинга PingTower спроектирована с учетом современных принципов разработки распределенных систем. Она обеспечивает безопасный, масштабируемый и надежный доступ ко всем функциям системы, а также поддерживает интеграцию с внешними инструментами и платформами.
