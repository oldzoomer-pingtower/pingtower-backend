# Техническое описание архитектуры REST API системы мониторинга PingTower

## 1. Введение

Этот документ описывает архитектуру и спецификацию REST API для системы мониторинга PingTower. REST API обеспечивает программный доступ ко всем функциям системы и позволяет интегрировать мониторинг с существующими DevOps-инструментами, системами управления инцидентами и платформами автоматизации.

## 2. Общая архитектура

### 2.1. Технологический стек

- **Язык программирования**: Java
- **Фреймворк**: Spring Boot
- **Система сборки**: Gradle
- **Аутентификация и авторизация**: OAuth2, Spring Security
- **Документирование API**: SpringDoc OpenAPI (Swagger)
- **Формат данных**: JSON

### 2.2. Принципы проектирования

API следует принципам RESTful архитектуры:

- **Состояние клиент-сервер**: Клиент и сервер отделены, что позволяет им развиваться независимо.
- **Без сохранения состояния**: Каждый запрос от клиента к серверу должен содержать всю информацию, необходимую для понимания запроса.
- **Кэшируемость**: Ответы сервера явно определяются как кэшируемые или некэшируемые.
- **Единообразный интерфейс**: Упрощает архитектуру и видимость взаимодействия.
- **Многоуровневая система**: Иерархия ограничений между компонентами.

### 2.3. Версионирование

API использует версионирование через URL:

```text
https://api.example.com/v1/
```

Это позволяет поддерживать несколько версий API одновременно и обеспечивает обратную совместимость.

### 2.4. Форматы данных

Все данные передаются в формате JSON. Заголовки запросов и ответов должны указывать на использование JSON:

```text
Content-Type: application/json
Accept: application/json
```

### 2.5. Обработка ошибок

API использует стандартные HTTP коды состояния для обозначения результата операции. Подробнее о кодах ошибок будет описано в соответствующем разделе.

## 3. Модули API

### 3.1. Settings Manager API

Модуль Settings Manager является центральным компонентом системы мониторинга PingTower, отвечающим за управление настройками всех модулей системы. Он обеспечивает централизованное хранение, управление и распространение конфигураций между различными компонентами системы.

Детали API описаны в файле [SETTINGS_MANAGER_API.md](SETTINGS_MANAGER_API.md).

### 3.2. Statistics API

Модуль Statistics отвечает за сбор, хранение, обработку и предоставление статистики и аналитики по результатам проверок доступности ресурсов.

Детали API описаны в файле [STATISTICS_API.md](STATISTICS_API.md).

## 4. Взаимодействие между модулями

### 4.1. Модули без REST API

Следующие модули не предоставляют REST API напрямую, но взаимодействуют с другими компонентами системы:

- **Pinger** - выполняет проверки доступности ресурсов. Управляется через Settings Manager.
- **Notificator** - отправляет уведомления о недоступности ресурсов. Управляется через Settings Manager.

### 4.2. Kafka

Модули системы взаимодействуют друг с другом через Apache Kafka:

- Settings Manager отправляет настройки проверок в топик `pingtower.check.configs`, откуда их получает Pinger.
- Pinger отправляет результаты проверок в топик `pingtower.check.results`, откуда их получает Statistics.
- Pinger отправляет уведомления о недоступности в топик `pingtower.check.alerts`, откуда их получает Notificator.

## 5. Аутентификация и авторизация

### 5.1. Механизмы аутентификации

API использует OAuth2 для аутентификации пользователей. Поддерживаются следующие провайдеры аутентификации:

- Keycloak (основной провайдер)
- Другие OAuth2-совместимые провайдеры

Для аутентификации клиенты должны получить токен доступа и передавать его в заголовке Authorization:

```text
Authorization: Bearer <access_token>
```

### 5.2. Авторизация

Авторизация осуществляется на основе ролей пользователей. Поддерживаются следующие роли:

- `PINGTOWER_USER` - базовый доступ к API
- `PINGTOWER_EDITOR` - возможность изменения настроек и запуска проверок
- `PINGTOWER_ADMIN` - полный доступ ко всем функциям системы

Детали описаны в файле [AUTHENTICATION_AUTHORIZATION.md](AUTHENTICATION_AUTHORIZATION.md).

## 6. Безопасность

### 6.1. Шифрование данных

- Все коммуникации между клиентами и API защищены с помощью TLS/HTTPS.
- Чувствительные данные (например, токены доступа к внешним системам) шифруются перед сохранением в базу данных.
- Используется AES-256 для шифрования данных.

### 6.2. Управление секретами

- API получает секреты через безопасный канал при запуске.

### 6.3. Аудит и логирование

- Все операции с данными логируются с указанием пользователя, времени и типа операции.
- Попытки несанкционированного доступа логируются и передаются в систему мониторинга.
- Подозрительные действия анализируются системой SIEM.

Детали описаны в файле [SECURITY.md](SECURITY.md).

## 7. Система ошибок и коды ответов

API использует стандартные HTTP коды состояния для обозначения результата операции:

- `200 OK` - Запрос успешно выполнен
- `201 Created` - Ресурс успешно создан
- `204 No Content` - Запрос успешно выполнен, но ответ пустой
- `400 Bad Request` - Некорректный запрос
- `401 Unauthorized` - Необходима аутентификация
- `403 Forbidden` - Недостаточно прав для доступа к ресурсу
- `404 Not Found` - Ресурс не найден
- `409 Conflict` - Конфликт при создании/обновлении ресурса
- `500 Internal Server Error` - Внутренняя ошибка сервера
- `503 Service Unavailable` - Сервис временно недоступен

Детали описаны в файле [ERROR_HANDLING.md](ERROR_HANDLING.md).

## 8. Документирование API

### 8.1. OpenAPI (Swagger)

API документируется с использованием спецификации OpenAPI (Swagger). Это позволяет:

- Автоматически генерировать документацию
- Создавать интерактивные документы для тестирования API
- Генерировать клиентские библиотеки для различных языков программирования

### 8.2. Доступ к документации

Документация доступна по следующим URL:

- Swagger UI: `https://api.example.com/v1/swagger-ui.html`
- OpenAPI JSON: `https://api.example.com/v1/v3/api-docs`

Детали описаны в файле [DOCUMENTATION.md](DOCUMENTATION.md).

## 9. Расширяемость

### 9.1. Модульная архитектура

API спроектирован с учетом модульности, что позволяет легко добавлять новые функции и расширять существующие.

### 9.2. Совместимость

При добавлении новых функций сохраняется обратная совместимость с предыдущими версиями API.

Детали описаны в файле [EXTENSIBILITY.md](EXTENSIBILITY.md).

## 10. Мониторинг и метрики

### 10.1. Health Checks

Реализованы эндпоинты для проверки состояния сервисов:

- `GET /health` - общее состояние системы
- `GET /health/liveness` - проверка живучести
- `GET /health/readiness` - проверка готовности к работе

### 10.2. Метрики

Сбор метрик производительности осуществляется через систему мониторинга.

## 1. Заключение

Архитектура REST API системы мониторинга PingTower спроектирована с учетом современных принципов разработки распределенных систем. Она обеспечивает безопасный, масштабируемый и надежный доступ ко всем функциям системы, а также поддерживает интеграцию с внешними инструментами и платформами.
