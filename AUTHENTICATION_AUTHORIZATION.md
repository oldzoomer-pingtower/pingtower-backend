# Механизмы аутентификации и авторизации

## 1. Аутентификация

### 1.1. OAuth2

API системы мониторинга PingTower использует OAuth2 для аутентификации пользователей и приложений. OAuth2 предоставляет безопасный и стандартный способ аутентификации, который поддерживается большинством современных приложений и библиотек.

### 1.2. Поддерживаемые провайдеры аутентификации

- **Keycloak** - основной провайдер аутентификации, используемый для управления пользователями и ролями внутри системы.
- **Другие OAuth2-совместимые провайдеры** - система может быть настроена для интеграции с другими OAuth2-провайдерами, такими как Google, GitHub, и т.д.

### 1.3. Получение токена доступа

Для аутентификации клиенты должны получить токен доступа от OAuth2-провайдера и передавать его в заголовке Authorization при каждом запросе к API:

```text
Authorization: Bearer <access_token>
```

### 1.4. Обновление токена доступа

Токены доступа имеют ограниченное время жизни. Когда токен истекает, клиент должен использовать refresh token для получения нового токена доступа без повторной аутентификации пользователя.

## 2. Авторизация

### 2.1. Ролевая система доступа (RBAC)

Авторизация в системе осуществляется на основе ролей пользователей. Каждый пользователь может иметь одну или несколько ролей, которые определяют его права доступа к различным функциям API.

### 2.2. Поддерживаемые роли

- **`PINGTOWER_USER`** - базовая роль, предоставляющая доступ к операциям чтения (GET) для большинства ресурсов.
- **`PINGTOWER_EDITOR`** - роль, предоставляющая доступ к операциям создания (POST), обновления (PUT, PATCH) и удаления (DELETE) для ресурсов настроек проверок и уведомлений.
- **`PINGTOWER_ADMIN`** - роль администратора, предоставляющая полный доступ ко всем функциям системы, включая управление пользователями и ролями.

### 2.3. Проверка прав доступа

При каждом запросе к API система проверяет, имеет ли пользователь соответствующую роль для выполнения запрашиваемой операции. Если у пользователя нет необходимой роли, запрос отклоняется с кодом ошибки 403 (Forbidden).

## 3. Управление пользователями и ролями

### 3.1. Создание пользователей

Пользователи могут быть созданы администраторами системы через Settings Manager API или через веб-интерфейс (если он доступен). При создании пользователя необходимо указать:

- Имя пользователя
- Email
- Имя и фамилия
- Начальный набор ролей

### 3.2. Назначение ролей

Администраторы могут назначать и отзывать роли у пользователей через Settings Manager API или веб-интерфейс. Изменения ролей вступают в силу немедленно.

### 3.3. Интеграция с внешними системами управления доступом

Система может быть настроена для интеграции с внешними системами управления доступом (например, LDAP, Active Directory) через Keycloak. В этом случае управление пользователями и ролями осуществляется во внешней системе, а Keycloak синхронизирует данные с ней.

## 4. Безопасность токенов

### 4.1. Хранение токенов

Клиенты должны безопасно хранить токены доступа и refresh токены. Рекомендуется использовать безопасные хранилища, такие как зашифрованные файлы или менеджеры паролей.

### 4.2. Передача токенов

Все коммуникации между клиентами и API должны осуществляться по защищенному каналу HTTPS. Передача токенов по незащищенным каналам строго запрещена.

### 4.3. Отзыв токенов

В случае компрометации токенов или подозрительной активности администратор может отозвать токены пользователя. После отзыва токены становятся недействительными, и пользователь должен пройти повторную аутентификацию.

## 5. Аудит и логирование

### 5.1. Логирование операций

Все операции с API логируются с указанием:

- Идентификатора пользователя
- Времени операции
- Типа операции (GET, POST, PUT, DELETE)
- Пути запроса
- Результата операции (успех/ошибка)

### 5.2. Мониторинг подозрительной активности

Система мониторинга отслеживает подозрительную активность, такую как:

- Множественные неудачные попытки аутентификации
- Запросы с необычных IP-адресов
- Попытки доступа к ресурсам без необходимых прав

При обнаружении подозрительной активности система может автоматически отозвать токены пользователя и уведомить администраторов.
